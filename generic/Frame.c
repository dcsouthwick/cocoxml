/*-------------------------------------------------------------------------
  Author (C) 2008, Charles Wang <charlesw123456@gmail.com>

  This program is free software; you can redistribute it and/or modify it 
  under the terms of the GNU General Public License as published by the 
  Free Software Foundation; either version 2, or (at your option) any 
  later version.

  This program is distributed in the hope that it will be useful, but 
  WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY 
  or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License 
  for more details.

  You should have received a copy of the GNU General Public License along 
  with this program; if not, write to the Free Software Foundation, Inc., 
  59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.

  As an exception, it is allowed to write an extension of Coco/R that is
  used as a plugin in non-free software.

  If not otherwise stated, any source code generated by Coco/R (other than 
  Coco/R itself) does not fall under the GNU General Public License.
-------------------------------------------------------------------------*/
#include  <ctype.h>
#include  <stdio.h>
#include  <stdlib.h>
#include  <string.h>
#include  "Frame.h"

static Bool_t
LocateMark(char ** b, char ** e, const char * lmark, const char * rmark)
{
    int llen = strlen(lmark), rlen = strlen(rmark);
    int tlen = llen + rlen;
    while (*b <= *e && isspace(**b)) ++*b;
    while (*b <= *e && isspace(**e)) --*e;
    if (*e - *b < tlen) return FALSE;
    if (strncmp(*b, lmark, llen)) return FALSE;
    if (strncmp(*e - rlen, rmark, rlen)) return FALSE;
    *b += llen; *e -= rlen;
    while (*b <= *e && isspace(**b)) ++*b;
    while (*b <= *e && isspace(**e)) --*e;
    return TRUE;
}

static Bool_t
CheckMark(char * lnbuf, char ** retCommand, char ** retParamStr)
{
    char * b, * e, * cmdTerm;
    if (!*lnbuf) return FALSE;
    b = lnbuf; e = lnbuf + strlen(lnbuf) - 1;
    if (!LocateMark(&b, &e, "/*----", "----*/")) return FALSE;
    *retCommand = b;
    while (b < e && isalnum(*b)) ++b; cmdTerm = b;
    if (!LocateMark(&b, &e, "(", ")")) *retParamStr = NULL;
    else { *retParamStr = b; *e = 0; }
    *cmdTerm = 0;
    return TRUE;
}

static int
TextWritter(FILE * outfp, char * lnbuf,
	    const char * replacedPrefix, const char * prefix)
{
    char * start, * cur; int len;
    if (!*replacedPrefix)
	return fputs(lnbuf, outfp) >= 0 ? 0 : -1;
    len = strlen(replacedPrefix);
    start = cur = lnbuf;
    while (*cur) {
	if (*cur != *replacedPrefix) ++cur;
	else if (strncmp(cur, replacedPrefix, len)) ++cur;
	else { /* An instance of replacedPrefix is found. */
	    *cur = 0;
	    if (fputs(start, outfp) < 0) return -1;
	    start = (cur += len);
	    if (fputs(prefix, outfp) < 0) return -1;
	}
    }
    return 0;
}

int
Frame(const char * frameFName, const char * outDir, const char * prefix,
      const char * license, void * cbData, frameCBFunc_t cbFunc)
{
    FILE * framefp, * outfp; Bool_t enabled;
    char outFName[4096], replacedPrefix[128];
    char lnbuf[4096], * Command, * ParamStr;

    outfp = NULL; enabled = TRUE;
    if (!(framefp = fopen(frameFName, "r"))) goto errquit0;
    while (fgets(lnbuf, sizeof(lnbuf), framefp)) {
	if (!CheckMark(lnbuf, &Command, &ParamStr)) {
	    if (outfp && enabled &&
		TextWritter(outfp, lnbuf, replacedPrefix, prefix) < 0)
		goto errquit1;
	} else if (!strcmp(Command, "open")) {
	    if (outfp != NULL) fclose(outfp);
	    snprintf(outFName, sizeof(outFName), "%s/%s", outDir, ParamStr);
	    if (!(outfp = fopen(outFName, "w"))) goto errquit1;
	} else if (!strcmp(Command, "prefix")) {
	    if (ParamStr == NULL) replacedPrefix[0] = 0;
	    else strncpy(replacedPrefix, ParamStr, sizeof(replacedPrefix));
	} else if (!strcmp(Command, "license")) {
	    if (outfp && TextWritter(outfp, lnbuf, NULL, NULL) < 0)
		goto errquit1;
	} else if (!strcmp(Command, "enable")) {
	    enabled = TRUE;
	} else if (!strcmp(Command, "disable")) {
	    enabled = FALSE;
	} else if (cbFunc(cbData, outfp, Command, ParamStr) < 0) {
	    goto errquit1;
	}
    }
    if (outfp != NULL)  fclose(outfp);
    fclose(framefp);
    return 0;
 errquit1:
    if (outfp != NULL) fclose(outfp);
    fclose(framefp);
 errquit0:
    return -1;
}
