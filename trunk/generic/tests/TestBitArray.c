/*-------------------------------------------------------------------------
  Author (C) 2008, Charles Wang <charlesw123456@gmail.com>

  This program is free software; you can redistribute it and/or modify it 
  under the terms of the GNU General Public License as published by the 
  Free Software Foundation; either version 2, or (at your option) any 
  later version.

  This program is distributed in the hope that it will be useful, but 
  WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY 
  or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License 
  for more details.

  You should have received a copy of the GNU General Public License along 
  with this program; if not, write to the Free Software Foundation, Inc., 
  59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.

  As an exception, it is allowed to write an extension of Coco/R that is
  used as a plugin in non-free software.

  If not otherwise stated, any source code generated by Coco/R (other than 
  Coco/R itself) does not fall under the GNU General Public License.
-------------------------------------------------------------------------*/
#include  <stdio.h>
#include  <stdlib.h>
#include  "BitArray.h"
#include  "AutoTests.h"

static void
BitArray_RandomSet(BitArray_t * self)
{
    long int rnd;
    int idx, bit, numbits = BitArray_getCount(self);
    for (idx = 0; idx < numbits; idx += 16) {
	rnd = rand();
	for (bit = 0; bit < 16 && idx + bit < self->numbits; ++bit)
	    if ((rnd & (1 << bit))) BitArray_Set(self, idx + bit, 1);
	    else BitArray_Set(self, idx + bit, 0);
    }
}

static void
DumpBitArray(FILE * fp, const char * format, const BitArray_t * ba)
{
    DumpBuffer_t dbuf; char buf[1024];
    DumpBuffer(&dbuf, buf, sizeof(buf));
    BitArray_Dump(ba, &dbuf);
    fprintf(fp, format, buf);
}

static void
ATest(FILE * fp, BitArray_t * ba0, BitArray_t * ba1)
{
    BitArray_t ba2;
    int idx, cnt, numbits = BitArray_getCount(ba0);

    DumpBitArray(fp, "Charset 0: %s\n", ba0);
    DumpBitArray(fp, "Charset 1: %s\n", ba1);

    cnt = 0;
    for (idx = 0; idx < numbits; ++idx)
	if (BitArray_Get(ba0, idx) && BitArray_Get(ba1, idx)) cnt = 1;
    COCO_ASSERT((BitArray_Intersect(ba0, ba1) == cnt));

    COCO_ASSERT((BitArray_Clone(&ba2, ba0)));
    COCO_ASSERT((BitArray_Equal(ba0, &ba2)));
    cnt = 0;
    for (idx = 0; idx < numbits; ++idx) {
	COCO_ASSERT(BitArray_Get(ba0, idx) == BitArray_Get(&ba2, idx));
	if (BitArray_Get(ba0, idx)) ++cnt;
    }
    COCO_ASSERT((BitArray_Elements(ba0) == cnt));

    COCO_ASSERT((BitArray_Or(&ba2, ba1) == 0));
    DumpBitArray(fp, "Or: %s\n", &ba2);
    for (idx = 0; idx < numbits; ++idx)
	COCO_ASSERT((BitArray_Get(ba0, idx) || BitArray_Get(ba1, idx)) == BitArray_Get(&ba2, idx));
    BitArray_Destruct(&ba2);

    COCO_ASSERT((BitArray_Clone(&ba2, ba0)));
    COCO_ASSERT((BitArray_And(&ba2, ba1) == 0));
    DumpBitArray(fp, "And: %s\n", &ba2);
    for (idx = 0; idx < numbits; ++idx)
	COCO_ASSERT((BitArray_Get(ba0, idx) && BitArray_Get(ba1, idx)) == BitArray_Get(&ba2, idx));
    BitArray_Destruct(&ba2);

    COCO_ASSERT((BitArray_Clone(&ba2, ba0)));
    BitArray_Subtract(&ba2, ba1);
    DumpBitArray(fp, "Subtract: %s\n", &ba2);
    for (idx = 0; idx < numbits; ++idx)
	COCO_ASSERT((BitArray_Get(ba0, idx) && !BitArray_Get(ba1, idx)) == BitArray_Get(&ba2, idx));
    COCO_ASSERT(!BitArray_Intersect(ba1, &ba2));
    BitArray_Destruct(&ba2);

    fprintf(fp, "\n");
}

void
TestBitArray(FILE * fp)
{
    int idx, numbits;
    BitArray_t ba0, ba1, ba2;

    for (numbits = 0; numbits < 32; ++numbits) {
	COCO_ASSERT((BitArray(&ba0, numbits)));
	COCO_ASSERT((BitArray(&ba1, numbits)));
	ATest(fp, &ba0, &ba1);
	BitArray_Destruct(&ba0); BitArray_Destruct(&ba1);

	COCO_ASSERT((BitArray(&ba0, numbits))); BitArray_SetAll(&ba0, 1);
	COCO_ASSERT((BitArray(&ba1, numbits)));
	ATest(fp, &ba0, &ba1);
	BitArray_Destruct(&ba0); BitArray_Destruct(&ba1);

	COCO_ASSERT((BitArray(&ba0, numbits)));
	COCO_ASSERT((BitArray(&ba1, numbits))); BitArray_SetAll(&ba1, 1);
	ATest(fp, &ba0, &ba1);
	BitArray_Destruct(&ba0); BitArray_Destruct(&ba1);

	COCO_ASSERT((BitArray(&ba0, numbits))); BitArray_SetAll(&ba0, 1);
	COCO_ASSERT((BitArray(&ba1, numbits))); BitArray_SetAll(&ba1, 1);
	ATest(fp, &ba0, &ba1);
	BitArray_Destruct(&ba0); BitArray_Destruct(&ba1);

	for (idx = 0; idx < 128; ++idx) {
	    COCO_ASSERT((BitArray(&ba0, numbits))); BitArray_RandomSet(&ba0);
	    COCO_ASSERT((BitArray(&ba1, numbits))); BitArray_RandomSet(&ba1);
	    ATest(fp, &ba0, &ba1);

	    COCO_ASSERT((BitArray_Clone(&ba2, &ba0)));
	    BitArray_Subtract(&ba2, &ba1);

	    ATest(fp, &ba0, &ba2);
	    ATest(fp, &ba2, &ba0);
	    ATest(fp, &ba1, &ba2);
	    ATest(fp, &ba2, &ba1);

	    BitArray_Destruct(&ba0); BitArray_Destruct(&ba1); BitArray_Destruct(&ba2);
	}
    }
}
